---
title: å¾®ä¿¡å°ç¨‹åºè·¯ç”±å®æˆ˜
category: æ¬ç –ç å†œ
date: 2021-03-21 20:28:00
tags: 
- å¾®ä¿¡å°ç¨‹åº
---

# 0. ç›®å½•

- [1. å‰è¨€](#1-å‰è¨€)
- [2. æ™ºèƒ½è·¯ç”±è·³è½¬ â€” Navigator æ¨¡å—](#2-æ™ºèƒ½è·¯ç”±è·³è½¬--navigator-æ¨¡å—)
- [3. è™šæ‹Ÿè·¯ç”±ç­–ç•¥ â€” Router æ¨¡å—](#3-è™šæ‹Ÿè·¯ç”±ç­–ç•¥--router-æ¨¡å—)
- [4. è½åœ°ä¸­è½¬ç­–ç•¥ â€” LandTransfer æ¨¡å—](#4-è½åœ°ä¸­è½¬ç­–ç•¥--landtransfer-æ¨¡å—)
  - [4.1. å¯¹äºè¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šç»Ÿä¸€çš„è½åœ°é¡µ](#41-å¯¹äºè¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜ç»Ÿä¸€çš„è½åœ°é¡µ)
  - [4.2. å¯¹äºç¬¬äºŒä¸ªè¦è§£å†³çš„é—®é¢˜ï¼šçŸ­é“¾å‚æ•°](#42-å¯¹äºç¬¬äºŒä¸ªè¦è§£å†³çš„é—®é¢˜çŸ­é“¾å‚æ•°)
  - [4.3. LandTransfer æ¨¡å—è®¾è®¡](#43-landtransfer-æ¨¡å—è®¾è®¡)
- [5. æ›´å¥½çš„å¼€å‘ä½“éªŒ](#5-æ›´å¥½çš„å¼€å‘ä½“éªŒ)
  - [5.1. Typescript + Router](#51-typescript--router)
  - [5.2. æ™ºèƒ½ç”Ÿæˆè·¯ç”±é…ç½®](#52-æ™ºèƒ½ç”Ÿæˆè·¯ç”±é…ç½®)
  - [5.3. è‡ªå®šä¹‰ç»„ä»¶è·³è½¬](#53-è‡ªå®šä¹‰ç»„ä»¶è·³è½¬)
- [6. æ•´ä½“æ¶æ„å›¾](#6-æ•´ä½“æ¶æ„å›¾)
- [7. æœ€åçš„æœ€å](#7-æœ€åçš„æœ€å)

# 1. å‰è¨€

åœ¨å¾®ä¿¡å°ç¨‹åºç”±ä¸€ä¸ª `App()`å®ä¾‹ï¼Œå’Œä¼—å¤š`Page()`ç»„æˆã€‚è€Œåœ¨å°ç¨‹åºä¸­æ‰€æœ‰é¡µé¢çš„è·¯ç”±å…¨éƒ¨ç”±æ¡†æ¶è¿›è¡Œç®¡ç†ï¼Œæ¡†æ¶ä»¥æ ˆçš„å½¢å¼ç»´æŠ¤äº†æ‰€æœ‰é¡µé¢ï¼Œç„¶åæä¾›äº†ä»¥ä¸‹ API æ¥è¿›è¡Œè·¯ç”±ä¹‹é—´çš„è·³è½¬ï¼š
1. `wx.navigateTo`
2. `wx.redirectTo`
3. `wx.navigateBack`
4. `wx.switchTab`
5. `wx.reLaunch` 

ä½†æ˜¯ï¼Œå¯¹äºä¸€ä¸ªä¼ä¸šåº”ç”¨ï¼ŒæŠŠè¿™äº›é—®é¢˜ç•™ç»™äº†å¼€å‘è€…ï¼š

1. åŸç”Ÿ API ä½¿ç”¨äº† `Callback` çš„å‡½æ•°å®ç°å½¢å¼ï¼Œä¸æˆ‘ä»¬ç°ä»£æ™®éçš„ `Promise` å’Œ `async/await` å­˜åœ¨ gapã€‚
2. åŸºäºå°ç¨‹åºè·¯ç”±çš„è®¾è®¡ï¼Œæš´éœ²ç»™å¤–éƒ¨çš„æ˜¯çœŸå®è·¯ç”±ï¼ˆå¦‚æ‰«ç ï¼Œå…¬ä¼—å·é“¾æ¥ç­‰æ–¹å¼ï¼‰ï¼Œå¯¹åç»­é¡¹ç›®é‡æ„ç•™ä¸‹å†å²åŒ…è¢±ã€‚
3. å°ç¨‹åºé¡µé¢æ ˆæœ€å¤šåå±‚ï¼Œ åœ¨è¶…è¿‡åå±‚å `wx.navigateTo` å¤±æ•ˆï¼Œéœ€è¦å¼€å‘è€…åˆ¤æ–­ä½¿ç”¨ `wx.redirectTo` æˆ–å…¶ä»–API
4. å°ç¨‹åºé¡µé¢æ ˆå­˜åœ¨ä¸€ç§ç‰¹æ®Šçš„é¡µé¢ï¼šTab é¡µé¢ï¼Œéœ€è¦ä½¿ç”¨ `wx.switchTab` æ‰èƒ½è·³è½¬ã€‚éœ€è¦å¼€å‘è€…ä¸»åŠ¨åˆ¤æ–­ï¼Œä¸æ–¹ä¾¿åæœŸæ”¹åŠ¨ Tab é¡µé¢å±æ€§ã€‚
5. é¢å¤–çš„ï¼Œå¯¹äºå°ç¨‹åºç ï¼Œè¦ä½¿ç”¨æ— æ•°é‡é™åˆ¶ API [wxacode.getUnlimited](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html) ï¼Œå­˜åœ¨å‚æ•°é•¿åº¦é™åˆ¶32ä½ä»¥å†…ã€‚éœ€è¦å¼€å‘è€…è‡ªè¡Œè§£å†³ã€‚

è€Œæœ¬æ–‡ï¼ŒæœŸæœ›èƒ½å¯¹è¿™è‹¥å¹²é—®é¢˜ï¼Œé€ä¸ªæä¾›è§£å†³æ–¹æ¡ˆã€‚



# 2. æ™ºèƒ½è·¯ç”±è·³è½¬ â€” Navigator æ¨¡å—

åœ¨è¿™é‡Œæˆ‘ä»¬ä¸€èµ·è§£å†³ï¼š

1. åŸç”Ÿ API é Promsie
2. é¡µé¢æ ˆçªç ´åå±‚æ—¶ç‰¹æ®Šå¤„ç†
3. ç‰¹æ®Šé¡µé¢ Tab çš„è·³è½¬å¤„ç†

æˆ‘ä»¬çš„æ€è·¯æ˜¯ï¼Œå¸Œæœ›èƒ½è®¾è®¡ä¸€ç§é€»è¾‘ï¼Œæ ¹æ®åœºæ™¯æ¥è‡ªåŠ¨åˆ¤æ–­ä½¿ç”¨å“ªä¸ªå¾®ä¿¡è·¯ç”± APIï¼Œç„¶åå¯¹å¤–åªæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œä¾‹å¦‚ï¼š

```javascript
gotoPage('/pages/goods/index')
```

å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š

1. å½“è·³è½¬çš„è·¯ç”±ä¸ºå°ç¨‹åº tab é¡µé¢æ—¶ï¼Œåˆ™ä½¿ç”¨ `wx.switchTab`ã€‚
2. å½“é¡µé¢æ ˆè¾¾åˆ° 10 å±‚ä¹‹åï¼Œå¦‚æœè¦è·³è½¬çš„é¡µé¢åœ¨é¡µé¢æ ˆä¸­ï¼Œä½¿ç”¨ `wx.navigateBack({ delta: X })` å‡ºæ ˆåˆ°ç›®æ ‡é¡µé¢ã€‚
3. å½“é¡µé¢æ ˆè¾¾åˆ° 10 å±‚ä¹‹åï¼Œç›®æ ‡é¡µé¢ä¸å­˜åœ¨é¡µé¢æ ˆä¸­ï¼Œä½¿ç”¨ `wx.redirectTo` æ›¿æ¢æ ˆé¡¶é¡µé¢ã€‚
4. å…¶ä»–æƒ…å†µä½¿ç”¨ `wx.navigateTo`

é¡ºå¸¦çš„ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå‡½æ•°ä»¥ Promise å½¢å¼å®ç°ï¼Œä»¥åŠæ”¯æŒå‚æ•°ä½œä¸º `object`ä¼ å…¥ï¼Œä¾‹å¦‚ï¼š

```javascript
gotoPage('/pages/goods/index', { name: 'jc' }).then(...).catch(...);
```

å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ï¼Œåªè¦ä½¿ç”¨`gotoPage`å°±èƒ½æ»¡è¶³ã€‚

é‚£è‚¯å®šä¹Ÿä¼šæœ‰ç‰¹å®šçš„æƒ…å†µï¼Œéœ€è¦æ˜¾å¼çš„æŒ‡å®šä½¿ç”¨ `navigateTo/switchTab/redirectTo/navigateBack`çš„å“ªä¸€ä¸ªã€‚

é‚£ä¹ˆæˆ‘ä»¬ä¹ŸæŒ‰ç…§ç±»ä¼¼çš„å®ç°ï¼Œæ»¡è¶³ç›¸åŒæ¨¡å¼çš„ API

```javascript
navigateTo('/pages/goods/index', { name: 'jc' }).then(...).catch(...);
switchTab('/pages/goods/index', { name: 'jc' }).then(...).catch(...);
redirectTo('/pages/goods/index', { name: 'jc' }).then(...).catch(...);
navigateBack('/pages/goods/index', { name: 'jc' }).then(...).catch(...);
```

è¿™äº›å‡½æ•°éƒ½å¯ä»¥å†…èšåˆ°åŒä¸€ä¸ªæ¨¡å—ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºï¼š**Navigator**

```javascript
const navigator = new Navigator();
navigator.gotoPage(...);
navigator.navigateTo(...);
navigator.switchTab(...);
navigator.redirectTo(...);
navigator.navigateBack(...);
```



æ¨¡å—è®¾è®¡ï¼š

![navigator-class](https://raw.githubusercontent.com/JerryC8080/figure-bed/master/img/20210321202552.png)



# 3. è™šæ‹Ÿè·¯ç”±ç­–ç•¥ â€” Router æ¨¡å—

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è§£å†³ï¼š

1. å¯¹å¤–æš´éœ²äº†çœŸå®è·¯ç”±ï¼Œå¯¼è‡´å†å²åŒ…è¢±æ²‰é‡çš„é—®é¢˜ã€‚

åœ¨è®¸å¤šåº”ç”¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦æŠŠæŸç§æ¨¡å¼åŒ¹é…åˆ°çš„æ‰€æœ‰è·¯ç”±ï¼Œå…¨éƒ½æ˜ å°„åˆ°åŒä¸ªé¡µé¢ä¸­å»ã€‚  
ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª Goods é¡µé¢ï¼Œå¯¹äºæ‰€æœ‰ ID å„ä¸ç›¸åŒçš„å•†å“ï¼Œéƒ½è¦ä½¿ç”¨è¿™ä¸ªé¡µé¢æ¥æ‰¿è½½ã€‚  

![](https://raw.githubusercontent.com/JerryC8080/figure-bed/master/img/20210321202632.png)



é‚£ä¹ˆåœ¨ä»£ç å±‚é¢ä¸Šï¼ŒæœŸæœ›èƒ½å®ç°è¿™æ ·çš„è°ƒç”¨æ–¹å¼ï¼š

```javascript
// åˆ›å»ºè·¯ç”±å®ä¾‹
const router = new Router();

// æ³¨å†Œè·¯ç”±
router.register({
  path: '/goods/:id', // è™šæ‹Ÿè·¯ç”±
  route: '/pages/goods/index', // çœŸå®è·¯ç”±
});

// è·³è½¬åˆ° /pages/goods/indexï¼Œå‚æ•°: onLoad(options) çš„ options = { id: '123' }
router.gotoPage('/goods/123');

// è·³è½¬åˆ° /pages/goods/indexï¼Œå‚æ•°: onLoad(options) çš„ options = { id: '456' }
router.gotoPage('/goods/456');
```

**Class Router** çš„æ ¸å¿ƒé€»è¾‘æ˜¯å®Œæˆï¼š

1. è·¯ç”±çš„æ³¨å†Œï¼Œå®Œæˆã€Œè™šæ‹Ÿè·¯å¾„ã€å’Œã€ŒçœŸå®è·¯å¾„ã€å…³ç³»çš„å­˜å‚¨ã€‚
2. æ»¡è¶³ã€Œè™šæ‹Ÿè·¯å¾„ã€åˆ°ã€ŒçœŸå®è·¯å¾„ã€çš„è½¬æ¢ï¼Œå¹¶ä¸”è¯†åˆ«ã€ŒåŠ¨æ€è·¯å¾„å‚æ•°ã€ï¼ˆdynamic segmentï¼‰ã€‚
3. è·¯ç”±è·³è½¬ã€‚

å¯¹äºã€Œè·¯ç”±çš„æ³¨å†Œã€ï¼Œæˆ‘ä»¬åœ¨å…¶å†…éƒ¨å­˜å‚¨ä¸€ä¸ª map å°±èƒ½å®Œæˆã€‚

è€Œå¯¹äºã€Œè·¯å¾„çš„è½¬æ¢ã€ï¼Œ `vue-router` æœ‰ç±»ä¼¼çš„å®ç°ï¼Œé€šè¿‡å…¶æºç å‘ç°ï¼Œå†…éƒ¨æ˜¯ä½¿ç”¨  [path-to-regexp](https://github.com/pillarjs/path-to-regexp) ä½œä¸ºè·¯å¾„åŒ¹é…å¼•æ“ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿æ¥ç”¨ä¹‹ã€‚

ç„¶åå¯¹äºã€Œè·¯ç”±çš„è·³è½¬ã€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¤ç”¨ä¸Šé¢æåˆ°çš„ **Navigator** æ¨¡å—ï¼Œé€šè¿‡è¾“å…¥çœŸå®è·¯å¾„ï¼Œæ¥å®Œæˆè·¯ç”±çš„è·³è½¬ã€‚



æ¨¡å—è®¾è®¡ï¼š

![route-class](https://raw.githubusercontent.com/JerryC8080/figure-bed/master/img/20210321202636.png)



å…¶ä¸­ï¼š

1. RouteMatcherï¼šæä¾›åŠ¨æ€è·¯ç”±å‚æ•°åŒ¹é…åŠŸèƒ½ï¼Œå†…éƒ¨ä½¿ç”¨  [path-to-regexp](https://github.com/pillarjs/path-to-regexp) ä½œä¸ºè·¯å¾„åŒ¹é…å¼•æ“ã€‚
1. Route: ä¸ºæ¯ä¸ªè·¯å¾„åˆ›å»ºè·¯ç”±å™¨ï¼Œå­˜å‚¨æ¯ä¸ªè·¯ç”±çš„è™šæ‹Ÿè·¯å¾„å’ŒçœŸå®è·¯ç”±çš„å…³ç³»ã€‚
1. Routerï¼šæ•´åˆå†…éƒ¨å„æ¨¡å—ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€ä¸”ä¼˜é›…çš„è°ƒç”¨æ–¹å¼ã€‚






# 4. è½åœ°ä¸­è½¬ç­–ç•¥ â€” LandTransfer æ¨¡å—

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è§£å†³ï¼š

1. å°ç¨‹åºæ‰«ç ã€å…¬ä¼—å·é“¾æ¥ç­‰åœºæ™¯ä¸‹çš„è½åœ°é¡µç»Ÿä¸€ã€‚
2. å°ç¨‹åºç ï¼Œå¯¹äºæ— é™é‡API [wxacode.getUnlimited](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html) ï¼Œçªç ´å‚æ•°32ä½é•¿åº¦é™åˆ¶ã€‚



## 4.1. å¯¹äºè¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šç»Ÿä¸€çš„è½åœ°é¡µ

æˆ‘ä»¬æŠŠå¦‚ï¼šæ‰«å°ç¨‹åºç ã€å…¬ä¼—å·èœå•ã€å…¬ä¼—å·æ–‡ç« ç­‰æ–¹å¼æ‰“å¼€å°ç¨‹åºæŸä¸ªé¡µé¢çš„è·¯å¾„ç§°ä¸ºã€Œå¤–éƒ¨è·¯ç”±ã€ã€‚

æ ¹æ®å°ç¨‹åºçš„è®¾è®¡ï¼Œæš´éœ²ç»™å¤–éƒ¨çš„è¿æ¥æ˜¯çœŸå®çš„é¡µé¢è·¯å¾„ï¼Œå¦‚ï¼š`/pages/home/index`ï¼Œè¯¥è®¾è®¡åœ¨å®è·µä¸­å­˜åœ¨çš„å¼Šç«¯ï¼š**å„ä¸ªè½åœ°é¡µåˆ†æ•£ï¼ŒåæœŸä¿®æ”¹çœŸå®æ–‡ä»¶è·¯å¾„éš¾åº¦å¤§ã€‚**

åœ¨ **ã€Œä¸­é•¿ç”Ÿå‘½å‘¨æœŸã€** äº§å“ä¸­ï¼Œéšç€äº§å“çš„è¿­ä»£ï¼Œæˆ‘ä»¬éš¾å…ä¼šé‡åˆ°é¡¹ç›®çš„é‡æ„ã€‚å¦‚æœåˆ†å‘å‡ºå»çš„éƒ½æ˜¯æ²¡ç»è¿‡å¤„ç†çš„çœŸå®è·¯å¾„çš„è¯ï¼Œæˆ‘ä»¬é‡æ„æ—¶å°±ä¼šæŸæ‰‹æŸè„šï¼Œè¦åšå¾ˆå¤šçš„å…¼å®¹æ“ä½œã€‚å› ä¸ºä½ ä¸çŸ¥é“ï¼Œåˆ†å‘å‡ºå»çš„å°ç¨‹åºäºŒç»´ç ï¼Œ æœ‰å¤šå°‘è¢«æ‰“å°åˆ°å®ä½“ç‰©æ–™ä¸­ã€‚

é‚£ä¹ˆï¼Œ**ã€Œè™šæ‹Ÿè·¯ç”±ã€+ã€Œè½åœ°ä¸­è½¬ã€** çš„ç­–ç•¥å°±æ˜¾å¾—åŸºæœ¬ä¸”é‡è¦äº†ã€‚

ã€Œè™šæ‹Ÿè·¯ç”±ã€çš„åŠŸèƒ½ï¼Œ**Router **æ¨¡å—ç»™æˆ‘ä»¬æä¾›äº†æ”¯æŒäº†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„è½åœ°é¡µé¢ï¼Œè®©å®ƒæ¥å®Œæˆå¯¹å†…éƒ¨è·¯ç”±çš„ä¸­è½¬ã€‚

åŸºæœ¬é€»è¾‘ï¼š

1. åˆ†å‘å‡ºå»çš„çœŸå®è·¯ç”±ï¼ŒæŒ‡å‘åˆ°å”¯ä¸€çš„è½åœ°é¡µé¢ï¼Œå¦‚ï¼š`$LAND_PAGE: /pages/land-page/index`
2. ç”±è¿™ä¸ªè½åœ°é¡µé¢ï¼Œè¿›è¡Œå†…éƒ¨è·¯ç”±çš„é‡å®šå‘è½¬å‘ï¼Œé€šè¿‡æ¥æ”¶ å‚æ•°ï¼Œå¦‚ï¼š`path=/user&name=jc&age=18`

![æ™®é€šæ¨¡å¼](https://raw.githubusercontent.com/JerryC8080/figure-bed/master/img/20210309185153.png)

åœ¨ä»£ç å±‚é¢ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å®ç°è¿™æ ·çš„ä½¿ç”¨ï¼š

```typescript
// /pages/land-page/index.ts

const landTransfer = new LandTransfer(landTransferOptions);

Page({
  onLoad(options) {
      landTransfer
        .run(options)
        .then(() => {...})
        .catch(() => {...});
  }
});
```

ç„¶åé’ˆå¯¹ TSï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨è£…é¥°å™¨ç‰ˆæœ¬ï¼Œæ›´åŠ ç®€ä¾¿ï¼š

```typescript
import { landTransferDecorator } from 'wxapp-router';

Page({
  @landTransferDecorator(landTransferOptions)
  onLoad(options) {
    // ...
  },
});
```



## 4.2. å¯¹äºç¬¬äºŒä¸ªè¦è§£å†³çš„é—®é¢˜ï¼šçŸ­é“¾å‚æ•°

å¾®ä¿¡å°ç¨‹åºä¸»è¦æä¾›äº†ä¸¤ä¸ªæ¥å£å»ç”Ÿæˆå°ç¨‹åºç ï¼š

1. [wxacode.get](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.get.html): è·å–å°ç¨‹åºç ï¼Œé€‚ç”¨äºéœ€è¦çš„ç æ•°é‡è¾ƒå°‘çš„ä¸šåŠ¡åœºæ™¯ã€‚**é€šè¿‡è¯¥æ¥å£ç”Ÿæˆçš„å°ç¨‹åºç ï¼Œæ°¸ä¹…æœ‰æ•ˆï¼Œæ•°é‡é™åˆ¶ä¸º 100,000** ä¸ª
2. [wxacode.getUnlimited](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html): è·å–å°ç¨‹åºç ï¼Œé€‚ç”¨äºéœ€è¦çš„ç æ•°é‡æå¤šçš„ä¸šåŠ¡åœºæ™¯ã€‚**é€šè¿‡è¯¥æ¥å£ç”Ÿæˆçš„å°ç¨‹åºç ï¼Œæ°¸ä¹…æœ‰æ•ˆï¼Œæ•°é‡æš‚æ— é™åˆ¶ã€‚**

ç¬¬ä¸€ç§æ–¹å¼ï¼Œ`wxacode.get` æ•°é‡é™åˆ¶ä¸º 10w ä¸ªï¼Œè™½ç„¶é‡å¾ˆå¤§äº†ï¼Œç»å¤§å¤šæ•°çš„å°ç¨‹åºå¯èƒ½ç”¨ä¸åˆ°è¿™ä¸ªé‡ã€‚

ä½†å¦‚æœæˆ‘ä»¬è¿è¥çš„æ˜¯ä¸€ä¸ªä¸­å¤§å‹ç”µå•†å°ç¨‹åºçš„è¯ï¼Œå‡å¦‚ï¼š1w ç§å•†å“ x 10 ç§å•†å“è§„æ ¼ï¼Œé‚£å°±ä¼šè¶…è¿‡è¿™ä¸ªæ•°é‡ã€‚åˆ°æ—¶å€™å†è¿›è¡Œæ”¹é€ ï¼Œå°±å›°éš¾äº†ã€‚

æ‰€ä»¥ï¼Œå¦‚æœæŠ±ç€æ˜¯è¿è¥ä¸€ä¸ª **ã€Œä¸­é•¿ç”Ÿå‘½å‘¨æœŸã€** çš„äº§å“çš„è¯ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ï¼š`wxacode.getUnlimited`

ä¸å°½äººæ„çš„æ˜¯ï¼Œè™½ç„¶å®ƒæ²¡æœ‰æ•°é‡é™åˆ¶ï¼Œä½†æ˜¯å¯¹å‚æ•°ä¼šæœ‰ 32 ä¸ªå­—ç¬¦çš„é™åˆ¶ï¼Œæ˜¾ç„¶æ˜¯ä¸å¤Ÿç”¨çš„ï¼ˆä¸€ä¸ª uuid å°± 32 å­—ç¬¦äº†ï¼‰ã€‚

å¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ã€ŒçŸ­é“¾å‚æ•°ã€çš„å½¢å¼è§£å†³ï¼Œç”±äº[wxacode.getUnlimited](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html) ä¼šé€šè¿‡ `scene`å­—æ®µä½œä¸º query å‚æ•°ä¼ é€’ç»™å°ç¨‹åºçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ `scene`å‚æ•°æ¥å®ç°çŸ­é“¾æœåŠ¡ï¼Œè¿™éœ€è¦åç«¯é…åˆã€‚

å‰åç«¯äº¤äº’å¦‚ä¸‹ï¼š

![SceneçŸ­é“¾æ¨¡å¼](https://raw.githubusercontent.com/JerryC8080/figure-bed/master/img/20210312182826.png)

1. å½“å°ç¨‹åºéœ€è¦ç”Ÿæˆå°ç¨‹åºç çš„æ—¶å€™ï¼Œè¯·æ±‚åç«¯æä¾›çš„æ¥å£ï¼Œä¾‹å¦‚ï¼š`/api/encodeShortParams`
2. åç«¯æŠŠå†…å®¹è½¬æ¢ä¸º 32 å­—ç¬¦å†…çš„å­—ç¬¦ä¸²ï¼Œå­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚
3. åç«¯é€šè¿‡ [wxacode.getUnlimited](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html) æ¥å£ï¼Œä»¥çŸ­é“¾å­—ç¬¦ä¸²ä½œä¸º `scene`çš„å€¼ï¼Œä»¥å•†å®šå¥½çš„ç»Ÿä¸€è½åœ°é¡µ `$LAND_PAGE`ä½œä¸º `page`å€¼ï¼Œç”Ÿæˆå°ç¨‹åºç ã€‚
4. å½“é€šè¿‡å°ç¨‹åºç è¿›å…¥å°ç¨‹åºï¼Œå°ç¨‹åºè·å–åˆ° `scene`å‚æ•°ï¼Œè¯·æ±‚åç«¯æä¾›çš„æ¥å£ï¼Œä¾‹å¦‚ï¼š`/api/decodeShrotParams`
5. å°ç¨‹åºç†è§£å†…å®¹ï¼Œè·³è½¬åˆ°ç›®æ ‡é¡µé¢ä¸­å»ã€‚



è€Œå‰ç«¯å¯¹äºç»Ÿä¸€è½åœ°é¡µçš„é€»è¾‘å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ç¬¬ä¸€ä¸ªé—®é¢˜çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ª**è½¬æ¢çŸ­é“¾å‚æ•°å†…å®¹**çš„é€»è¾‘å°±è¡Œäº†ï¼š

![çŸ­é“¾æ¨¡å¼](https://raw.githubusercontent.com/JerryC8080/figure-bed/master/img/20210309185154.png)



ä»£ç å±‚é¢ä¸Šï¼Œæˆ‘ä»¬æˆ‘ä»¬åªéœ€è¦å¤šå®šä¹‰è½¬æ¢çŸ­é“¾å‚æ•°çš„æ–¹å¼ï¼š`convertScenePrams`

```typescript
// in /pages/land-page/index.js
import { landTransferDecorator } from 'wxapp-router';

const landTransferOptions = {
  // æ­¤å¤„æ¥æ”¶ onLoad(options) ä¸­çš„ options.scene
  convertSceneParams: (sceneParams) => {
    return API.convertScene({ sceneParams }).then((content) => {
      // å‡å¦‚åç«¯å­˜çš„æ˜¯ JSON å­—ç¬¦ä¸²ï¼Œå‰ç«¯decode
      // è¦æ±‚ content = { path: '/home', a: 1, b:2 }
      return JSON.parse(content);
    });
  },
};

Page({
  @landTransferDecorator(landTransferOptions)
  onLoad(options) {
    // ...
  },
});
```

è€Œå…¶ä¸­çš„ `API.convertScene` å°±å¯¹æ¥æœåŠ¡ç«¯æä¾› HTTP æ¥å£æœåŠ¡æ¥å®Œæˆã€‚



## 4.3. LandTransfer æ¨¡å—è®¾è®¡

![land-transfer](https://raw.githubusercontent.com/JerryC8080/figure-bed/master/img/20210321202654.png)



# 5. æ›´å¥½çš„å¼€å‘ä½“éªŒ

## 5.1. Typescript + Router

å¯¹äºå°ç¨‹åºå†…éƒ¨çš„è·¯ç”±è·³è½¬ï¼Œæˆ‘ä»¬é™¤äº†æŒ‡å®šä¸€ä¸ªå­—ç¬¦ä¸²çš„è·¯ç”±ï¼Œæˆ‘ä»¬æ˜¯å¦ä¹Ÿå¯ä»¥é€šè¿‡é“¾å¼è°ƒç”¨ï¼Œåƒè°ƒç”¨å‡½æ•°é‚£æ ·å»è·³è½¬é¡µé¢å‘¢ï¼Ÿç±»ä¼¼è¿™æ ·ï¼›

```typescript
routes.pages.user.go({ name: 'jc' });
```

è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š

1. æ›´è‡ªç„¶çš„è°ƒç”¨æ–¹å¼ã€‚
2. èƒ½ç»“åˆ TSï¼Œæ¥åšåˆ°ç±»å‹æç¤ºå’Œè”æƒ³ã€‚

ç”±äºäº‹å…ˆ `wxapp-router` å¹¶ä¸çŸ¥é“å¼€å‘è€…éœ€è¦æ³¨å†Œçš„è·¯ç”±æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œæ‰€ä»¥è·¯ç”±çš„ TS å£°æ˜æ–‡ä»¶ï¼Œéœ€è¦å¼€å‘è€…æ¥å®šä¹‰ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç»´æŠ¤ä¸€ä»½è·¯ç”±æ–‡ä»¶ï¼š

```typescript
// config/routes.ts

// åˆ›å»ºè·¯ç”±å®ä¾‹
const router = new Router();

const routesConfig = [{
  path: '/user',
  route: '/pages/user/index',
}, {
  path: '/goods',
  route: '/pages/goods/index',
}]ï¼›

type RoutesType {
  paegs: {
    user: Route<{name: string}>,
    goods: Route,
  }
}

// æ³¨å†Œè·¯ç”±
router.batchRegister(routesConfig);

// è·å– routes
const routes: RoutesType = router.getRoutes();

export default routes;
```

ç„¶ååœ¨åˆ«çš„åœ°æ–¹ä½¿ç”¨å®ƒï¼š

```typescript
import routes from './routes.ts';

routes.pages.user.go({ name: 'jc' });
```



## 5.2. æ™ºèƒ½ç”Ÿæˆè·¯ç”±é…ç½®

å¦‚æœè·¯ç”±å˜å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹æ¯ä¸ªè·¯ç”±æ‰‹åŠ¨å»ç¼–å†™ `RoutesType` çš„è¯ï¼Œå°±æœ‰ç‚¹éš¾å—äº†ã€‚

åœ¨å°ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æŠŠæ­£å¼è·¯ç”±éƒ½é…ç½®åˆ° `app.json` ï¼Œé‚£ä¹ˆåœ¨éµå¾ªæ—¢å®šçš„é¡¹ç›®ç»“æ„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªåŠ¨æ„å»ºï¼Œå®Œæˆå¤§éƒ¨åˆ†å·¥ä½œï¼Œä¾‹å¦‚ï¼š

1. æ™ºèƒ½æ³¨å†Œè·¯ç”±
2. æ™ºèƒ½è¯†åˆ«é¡µé¢å…¥å‚å£°æ˜



## 5.3. è‡ªå®šä¹‰ç»„ä»¶è·³è½¬

ä»¥ä¸Šéƒ½æ˜¯è„šæœ¬å±‚é¢çš„ä½¿ç”¨ï¼Œå°ç¨‹åºä¸­è¿˜æœ‰ `wxml`, æˆ‘ä»¬å¸Œæœ›èƒ½åœ¨æœ‰ä¸ªç»„ä»¶å¿«é€Ÿä½¿ç”¨ï¼š

```html
<Router path="/pageA" query="{{pageAQuery}}"></Router>
<Router path="/pageB" query="{{pageBQuery}}" type="redirectTo"></Router>
<Router path="/pageC/katy"></Router>
```

é‚£ä¹ˆï¼Œå®ç°ä¸€ä¸ªè‡ªå®šä¹‰ç»„ä»¶ï¼Œç„¶åæŠŠ **Router**æ¨¡å—åŒ…è£…ä¸€ä¸‹ï¼Œé—®é¢˜å°±ä¸å¤§äº†ã€‚



ç¤ºä¾‹ä»£ç ï¼š

```html
// components/router.wxml

<view class="wxapp-router" bind:tap="gotoPage">
    <slot />
</view>
```

```typescript
// components/router.ts

Component({
    properties: {
        path: String,
        type: {
            type: String,
            value: 'gotoPage'
        },
        route: String,
        query: Object,
        delta: Number,
        setData: Object,
    },

    methods: {
        gotoPage(event) {
            const router = getApp().router;
            const { path, route, type, query} = this.data;
            const toPath = route || path;

            if (['gotoPage', 'navigateTo', 'switchTab', 'redirectTo'].includes(type)) {
                (router as any)[type](toPath, query);
            }

            if (type === 'navigateBack') {
                const { delta, setData } = this.data;
                router.navigateBack({ delta }, { setData })
            }
        }
    }
})
```





# 6. æ•´ä½“æ¶æ„å›¾

æœ€åï¼Œæˆ‘ä»¬æ¥æ•´ä½“å›é¡¾ä¸€ä¸‹å„æ¨¡å—çš„è®¾è®¡

![æ¶æ„è®¾è®¡](https://raw.githubusercontent.com/JerryC8080/figure-bed/master/img/20210321202700.png)

1. Navigatorï¼šå°è£…å¾®ä¿¡åŸç”Ÿè·¯ç”± APIï¼Œæä¾›æ™ºèƒ½è·³è½¬ç­–ç•¥ã€‚
1. LandTransferï¼šæä¾›è½åœ°é¡µä¸­è½¬ç­–ç•¥ã€‚
1. RouteMatcherï¼šæä¾›åŠ¨æ€è·¯ç”±å‚æ•°åŒ¹é…åŠŸèƒ½ã€‚
1. Route: ä¸ºæ¯ä¸ªè·¯å¾„åˆ›å»ºè·¯ç”±å™¨ã€‚
1. Routerï¼šæ•´åˆå†…éƒ¨å„æ¨¡å—ï¼Œå¯¹å¤–æä¾›ä¼˜é›…çš„è°ƒç”¨æ–¹å¼ã€‚
1. Loggerï¼šå†…éƒ¨æ—¥å¿—å™¨ã€‚
1. Path-to-regexp: å¼€æºç¤¾åŒºçš„è·¯ç”±åŒ¹é…å¼•æ“ã€‚



# 7. æœ€åçš„æœ€å

é‰´äºå†™è¿‡å¾ˆå¤šçš„å®æˆ˜ç±»çš„æ–‡ç« ï¼Œä¼šæœ‰ä¸å°‘åŒå­¦æƒ³è¦åˆ°æ•´ä½“çš„ç¤ºä¾‹ä»£ç ï¼Œè¿™æ¬¡æˆ‘å°±ç´¢æ€§å†™äº†ä¸€ä¸ªå·¥å…·ï¼ŒEnjoy it!

[wxapp-router](https://github.com/JerryC8080/wxapp-router)ï¼š ğŸ›µ The router for Wechat Miniprogram