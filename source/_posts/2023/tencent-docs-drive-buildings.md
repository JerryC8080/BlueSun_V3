---
title: 架构始于业务，腾讯文档 Drive 前端中台建设（万字长文）
category: 搬砖码农
date: 2023-08-19 07:22:25
tags: 
- 架构
---

# 前言

在 2022 年初，腾讯文档结合行业趋势和业务发展，提出了「Drive」概念。

此前，由于「在线文档类」产品独特的行业环境和战略考虑，编辑功能成为早期发展重心。因此，我们对模块的划分以较粗的枝条划分为「编辑」和「非编辑」两大类。编辑功能以 Doc、Sheet、Slide 三大品类为核心，解决在线文档产品特有的业务场景，如在线协作、Office 格式兼容等。非编辑功能则包括登录、权限、列表和编辑过程中所需的功能组件，以及完成一款互联网应用所需要的其他所有功能。

在集中战力攻占「在线文档」独特的业务挑战之后，随着业务发展和用户需求变化，编辑以外的功能面临新的挑战。例如，用户对仅承载在线文档的列表页不再满足，需要文件分类、文件夹、收藏、回收站等功能。用户的文件多了，就有了分类的需要，就有了文件夹、收藏、回收站等述求。协作的场景多了，又有了文件协作管理的需要，就有了协作空间。有了文件协作之后，又有了对于音频、视频、图片等更多文件类型的存储和消费，以及分享能力的述求。然后，又有了第三方接入的述求，例如智影（视频剪辑）、ProcessOn（思维导图）、BoardMix（协同白板）等。

以三大品类为主语的「列表页」，已经不能满足业务的发展和用户新需求。为了满足用户新需求，助力产品增长，我们需要重新审视「非编辑」这件事。新成立的文档管理产研团队，帮忙理清了至关重要的事情，提出文档管理五大中台的概念：帐号中台、Drive 中台、权限中台、协作中台、安全中台。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308081109405.png" alt="文档管理五大中台" style="zoom: 30%;" />



Drive 中台是其中之一，那怎么去落地这个中台？从技术的角度考虑，不能仅满足单点的去完成产品拆分过的需求。

一款产品要综合考虑商业和战略，而有所取舍或者择重的。而技术在做设计或者架构的时候，本质要考虑的问题是扩展性，这要求我们要比产品看得更远。如果一款产品永远不会变化，就没有架构的必要。如果产品在不断的变化，我们就需要预测他变化的方向。

技术团队不仅要执行，还需要具备对产品远景的想象力，抓住本质，建设好地基，以在未来的产品迭代中，能更好的支持用户的新需求在此基础上快乐的蹦跶。

因此，我们面临的首要问题便是：**「Drive」的能力圈应该怎么定义？**。即 Drive 应该具备哪些能力？有哪些标杆和竞品？Drive 在竞品中的结构如何？从行业趋势来看，Drive 未来的发展方向又是怎么样？



# 一、Drive 的能力圈在哪里？

## 1. Drive 的标杆竞品是谁？

上世纪七十年代末由施乐公司首创的「标杆分析法 Benchmaking」，用来模仿美国企业的管理和营销方法。
虽然这套方法非常细节，但在本场景中，没必要照抄全套流程。我们仅需吸收其核心思想，培养自身意识。
因此，解答「Drive 的能力圈」的第一个命题就是：**「Drive 中台的标杆在哪？竞品是谁？」**



**按产品属性寻找竞品**

如果只从在线协作的三大品类的编辑功能来看的话，腾讯文档着实属于「在线文档」行业产品，从「在线文档」行业角度来看，竞品是：Google Docs、金山文档、石墨文档、飞书文档等。
然而随着产品迭代，需求可能不仅局限在「在线文档」，当我们需要增强云盘能力的时候，从「云盘」行业角度来看，竞品又包括：微云、阿里云盘、百度云盘、天翼云盘等。
此外，从行业发展趋势出发，结合一门三杰（企微、文档、会议），从「办公套件」行业角度来看，竞品还有：Google Workspace、飞书、金山办公等。



**看见行业发展趋势**

从这个脉络来看，隐约能感受到行业内的产品，是有一定的历史进程和发展趋势的。而当我们将三个行业的竞品放在同一个时间线来看的话，这个产品演变趋势就变得直观了。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308182243178.png" alt="竞品产品发展趋势时间线" style="zoom: 100%;" />

从历史的角度来总结「云盘」、「在线文档」、「企业办公套件」的产品变迁，发现主要经历了以下几个阶段：

1. **本地文档编辑时代：**在计算机普及之初，人们主要依靠本地办公软件进行文档的创建、编辑和存储，如 Microsoft Office、WPS Office 等。这些办公套件为用户提供了基本的办公功能，但在文件共享和协作方面存在局限。
2. **本地硬盘存储时代：**随着互联网的发展，人们开始使用电子邮件、FTP等方式进行文件的存储和共享。这些方法虽然能满足基本需求，但操作繁琐，且难以支持多人协作。
3. **网盘时代：**云计算技术的发展催生了网盘服务，如 Dropbox、微云、百度网盘等。这些服务提供了文件的云端存储、备份和分享功能，使得文件存储和共享变得更加便捷。然而，网盘服务仍缺乏在线协作功能。
4. **在线文档编辑时代：**随着 Web 技术的进步，出现了一些在线文档编辑工具，如 Google Docs、Microsoft Office Online 等。这些工具使得用户可以在浏览器中直接创建、编辑文档，无需安装本地软件。然而，这些工具在早期并未与网盘服务紧密结合，用户仍然需要将文件上传至网盘进行存储和共享。
5. **云协作时代：**近年来，云盘和在线文档编辑工具逐渐融合，形成了一系列在线文档协作平台，如 Google Drive、Microsoft OneDrive 等。这些平台不仅提供文件的存储、备份、分享功能，还支持在线创建、编辑、协作等功能。用户可以在这些平台上与他人实时协作，提高工作效率。
6. **企业办公套件时代：**为了满足企业用户的需求，一些企业办公套件开始整合云盘、在线文档协作、IM、会议等功能，形成了一站式办公平台，如 Microsoft 365、Google Workspace、金山 WPS 365、飞书等。这些平台提供了丰富的办公应用和服务，帮助企业提高协作效率、降低成本。

从云盘、在线文档协作，再到企业办公套件，这段产品变迁史反映了互联网技术的发展和用户需求的变化。

综合以上分析，**Drive 中台的标杆竞品应当是三个细分行业（云盘、在线文档、企业办公套件）下的产品。**



## 2. Drive 在标杆竞品中的结构如何？

在分析了几个细分行业的产品结构之后，发现 Drive 中台在不同的标杆竞品中有不同的定位。
从在线文档角度来看，Drive 重点在于协作，而不是云盘功能。例如，金山文档和石墨文档主要侧重于在线文档协作，基于在线文档的简单列表管理。
从云盘行业角度来看，Drive 更注重云盘功能，而协作功能相对较弱。例如微云、百度云盘等。
而从办公套件角度来看，Drive 既重视云盘功能，也注重协作功能，通常 Drive 会作为独立的产品应用。例如，Google Workspace、金山 WPS 365、飞书等办公套件中，网盘功能作为独立的产品应用，拥有更强的网盘管理能力。
从竞品的结构来看，可以看得出**「Drive 中台是在线文档领域的基础能力」**


## 3. 归纳 Drive 的能力圈

在分析过三个细分行业竞品的 Drive 功能和能力之后，发现无论是重 Drive 还是轻 Drive，都可以归纳成三个大的维度：**文件生产、文件消费、文件管理。**

按照大的功能模块来分的话，大部分可以归纳成如下：

1. **文件生产：**
  a. 上传功能：用户可以通过拖拽、拍照、截图、选择等方式上传文件，并支持各种格式的文件，如文档、图片、视频、压缩包等。
  b. 在线创建：部分产品提供在线创建功能，如在线新建文档、表格、幻灯片等，方便用户直接在网盘中进行文件的创建和编辑。在线文档产品还会增强这部分能力，提供协作编辑能力。
  c. 第三方集成：部分产品支持与第三方应用集成，如与办公软件、图片编辑工具等结合，方便用户在网盘中直接使用这些工具进行文件的创建和编辑。

2. **文件消费：**
  a. 在线预览：支持对各类文件进行在线预览，用户无需下载文件即可查看内容，像音视频播放、文档预览、文件解压等。
  b. 文件分享：用户可以在场内生成分享链接，将文件分享给其他人查看或下载。
  c. 在线协作：部分产品提供在线协作功能，多人可以共同编辑同一个文件，提高团队协作效率。
  d. 文件下载：用户可以将网盘中的文件下载到本地设备进行使用。云盘类的产品会更加增强这部分能力，像提供种子离线下载等。

3. **文件管理：**
  a. 文件分类：大部分产品支持用户对文件进行分类管理，如创建文件夹、设置标签等。这大类又能派生出像回收站、协作空间等功能。
  b. 文件搜索：用户可以通过关键词、文件类型等条件在网盘中搜索文件，快速找到所需内容。又能派生出排序、筛选等功能。
  c. 文件版本控制：部分产品提供文件版本控制功能，用户可以查看和恢复文件的历史版本。
  d. 权限管理：产品能支持用户设置文件的访问权限，如查看、编辑、下载等，确保文件的安全性。
  e. 数据备份与恢复：网盘会对用户的文件进行备份，防止意外丢失。部分网盘还提供数据恢复功能，帮助用户找回误删的文件。




<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308190028191.png" alt="Drive 中台的能力圈" style="zoom:40%;" />



到目前为止，其实多少能看到 Drive 未来的趋势。技术架构的目标是能够包容产品未来发展方向和用户需求变化。Drive 以文件为核心，始终关注「生产、消费、管理」的基本面是不会变的，这就是我们应该去夯实的能力。

产品团队则可以根据战略、商业和定位，选择将产品塑造为在线文档、云盘或办公套件等细分行业。每一款产品或者每一个行业，都有其要解决的主要问题。例如，电商行业关注「人货场」，而 **Drive 产品则专注于「文件的生产、消费、管理」**。



# 二、现状是如何？

麦肯锡的金字塔原理，跟我们强调要用结构性思维去分析和解决问题。前面我们找到了目标 R2，也就是我们的诗和远方。接着呢，我们需要分析现状 R1，最后找到 R1 → R2 的方法。那么腾讯文档 Drive 前端的现状又是如何呢？
基于战略的考虑，在产品初期虽然重点在「编辑」，但是对于文件的需求仍然较多，如列表管理、上传下载，附件预览等。
然而，由于还没有统一的 Drive 中台概念，在业务快速迭代下，难免会有多个业务方重复实现，或存在多套标准的问题。而业务快速发展的同时，团队也在不断的变化，也难免导致相同模块维护人员多次更替，交接失真，文档缺失，而代码也逐渐的腐化。
总结来看，存在两个问题：**「腐化」和「分散」**。这导致的结果是开发效率逐渐下降，旧的改不动，新的无复用。
从软件生命周期的发展来看，着实已经到达了一个效率瓶颈节点。



<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308120908718.png" alt="软件生命周期" style="zoom:80%;" />



## 1. 混乱的文件定义

**第一个例子是，针对「文件」这一概念，已经存在多套模型和概念。**
例如，在列表页中，功能还需细分为「搜索页」、「列表页」、「分享页」和「容量页」等，每个功能都有各自的文件模型。
同时，在各个产品类别中插入的图片、音频、视频等文件，又被称为另一种文件：「附件」。
更为复杂的是，这些不同的文件模型的数据来源对应多套后端接口，以及不同的请求体和响应体。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308171551183.png" alt="多套文件模型和概念" style="zoom:80%;" />

这种现状导致了许多问题。
例如**从性能上看**，若要在列表页快速预览一个文件，「列表页」和「预览」作为两个模块，如何传输文件呢？如果通过 id 传输，将导致调用链路中的每个节点都需要进行接口查询，造成不必要的重复消耗，无法实现流畅的预览体验。
再者**从效率上看**，如果传输整个文件对象，需要在两个模块之间完成全双工文件传输，至少需要维护两个 Transform 胶水方法。在极端情况下，如果上述五个模块之间都需要全双工文件传输，根据组合，至少需要 20 个 Transform 胶水方法。此时，如果需要将一个新模块添加到通信网络中，每个原有模块都需要增加一个 Transform。例如，当我们需要修改文件的 ICON 或新增一种文件格式时，每个模块、每个文件模型和每个 Transform 都需要进行修改，这将导致成本呈指数级增长。



## 2. 混乱的文件预览

**在第二个例子中，针对文件预览这个功能，也有多套实现方式。**
如前文所述，有五个文件概念，实际情况更为复杂。从预览角度来看，文件可分为「云文件」、「附件」和「插件」等。
云文件（Drive 文件）是指我们上传的 Office 格式文件，如传统的 Word、Excel、PowerPoint 等。我们支持对这些文件进行预览，呈现方式为独立页面预览。
附件是指在线文档编辑中插入的图片、音频、视频等文件。我们支持对这些文件进行快速预览，呈现方式为内嵌和全屏浮层。
插件是指与第三方合作的文件，如智影等。我们支持对这类文件的预览图进行快速查看，呈现方式为浮层弹窗预览。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308171552496.png" alt="多套文件预览" style="zoom:80%;" />

这些模块都实现了同一个功能：「文件预览」，但却是独立实现的。这导致了复用困难，例如在为云文件支持图片、音频、视频预览时，无法简单复用。同样，如果附件需要支持 Office 文档的插入和预览，也无法快速满足需求。
总的来说，腾讯文档的文件能力目前是「分散」的，产品内存在多套文件概念、多套上传下载能力、多套文件选择能力等。

前面我们了解了 Drive 的大致蓝图，现在又明白了现状的复杂性。接下来，我们需要寻找从现状走向诗和远方的道路。Drive 概念的提出以及建设统一的 Drive 中台是一种方法，其核心在于**「统一」**，重点在于**「梳理」**。然后，在执行过程中，深入细节，逐步解决去「腐化」问题。



# 三、概要设计 — 技术与架构

架构这个活儿挺讲究的，铺的大了，可能会难以落地，成了空泛之谈。铺的小了，又好像不够逼格，不够证明思考全面。
实际上，我们已经看到了诗和远方 —— Drive中台，即「文件的生产、消费、管理」。
正如陆游所言：「纸上得来终觉浅，绝知此事要躬行。」，那便让我们从现状入手，运用架构设计的知识和原则作为方法论，逐步搭建起这座大厦。
首先，我们可以从单点出发，分析如何解决前文提到的两个现状问题。


## 1. 统一的文件定义和文件模型

首先，我们需要解决多套文件概念和文件模型的问题。核心思路是**「统一」**，其实后面会发现，在文档管理产研团队的工作中，许多任务都与「统一」这个词密切相关。


**统一的第一步，先梳理文件的定义。**

经过产品和研发团队多次讨论，并结合现状，我们最终梳理出了文件的定义：

1. **Drive 文件 = 云文件 + 在线协作文档文件 + 第三方文件 + 附件**
2. 当 Drive 文件与腾讯文档文件产生从属关系时，则称为**附件**

**云文件**：指用户通过上传（或其他方式）产生的所有格式文件，如 Office 文件、PDF 文件、音视频文件、压缩包、安装包等。根据前面梳理的三大细分行业，支持云文件可以涵盖云盘类产品的场景。

**在线协作文档文件**：指用户在产品内部创建的在线协作文档，属于在线协作文档类产品中生成的特殊格式文件。如果说我们平时对于 Office 文件的文件名是 `《架构始于业务，腾讯文档 Drive 前端中台建设》.docx`，那么转换成在线文档后，就是 `《架构始于业务，腾讯文档 Drive 前端中台建设》.tdoc`。当然，仅使用类似 `docx`、`tdoc` 这样的文件后缀名可能无法满足灵活的需求变化，这一点我们后面会讲到。

**第三方文件**：指产品对接第三方所产生的特殊格式文件。例如，腾讯文档已接入智影（视频剪辑）、ProcessOn（思维导图）、BoardMix（协同白板）等。这些文件存储在我们的系统中，是由 Drive 文件派生出的特殊格式文件。

**附件**：在我们的系统中，文件之间会产生从属关系，如文件夹和在线协作文档中引用的其他文件。与 Linux 系统中的观念相似，万物皆文件。当 Drive 文件与腾讯文档文件产生从属关系时，Drive 文件就成为附件。

文件概念的统一至关重要，不仅有利于产研团队之间的沟通，降低沟通成本，还有利于技术细节的设计，大到架构设计，小到变量命名。



<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308182340927.png" alt="image-20230818234010116" style="zoom:30%;" />



刚才说到我们不能只用文件后缀名来区别文件，为什么呢？

例如，视频类文件有多种格式，如 mp4/avi/mkv/mov/wmv/flv 等数十种。如果我们要区分这些视频文件，仅使用后缀名可能需要建立一个庞大的映射表。

此外，对于「在线协作文档」和「第三方文件」这类文件，我们如何自定义后缀名？又怎么去进行统一判断呢？仅使用后缀名的话，多少有点繁琐。

在竞品调研过程中，我们发现 Google Drive 使用了一种可能较少人知晓的标准来完成文件区分：[Multipurpose Internet Mail Extensions](http://www.iana.org/assignments/media-types/media-types.xhtml) ，缩写为 MIME Type。

在 Mac 和 Linux 中也都会内置一份 MiME Type 的映射文件：

1. Linux 系统：`/etc/mime.types `
2. macOS 系统：`/etc/apache2/mime.types`

这种标准以结构化的方式完成了文件的区分，同时还支持第三方扩展。例如，当我们要区分视频文件时，就只需判断 `video/*`，图片文件则为 `image/*`，音频文件为 `audio/*` 。对于特殊的在线协作文档，我们可以使用自定义的 `application/tencent-docs.*` 来区分等。这样，我们可以更简洁、灵活地区分文件类型。



**统一的第二步，建设统一的文件模型。**
「单向依赖原则」指导我们只允许较高层次依赖较低层次，而不允许反向依赖。前文提到的多套文件模型之间的网状依赖关系就有悖于这一原则。实际上，问题的本质原因在于没有进行分层。在我们梳理清楚「文件的定义」之后，我们就能进行分层了。

首先，我们构建 **DriveFile** 模型。考虑到我们希望所有末端能方便地消费它，它需要更好地承载和传递数据。在复杂的前端环境中，最佳的传输形式是 JSON，这要求它应该是一个较为干净的数据结构。因此，我们应该采用「贫血模型」来设计这个模型，其职责是描述文件固有的属性。而至于文件的操作和文件的构造应当交给其他模块。
由于 **DriveFile = CloudFile + TDocFile + ThirdFile + Attachment**（Drive 文件 = 云文件 + 在线协作文档文件 + 第三方文件 + 附件），不同场景对文件的细分有所要求。基于「单向依赖原则」的其中一种实现 ——「工厂模式」设计模式，我们需要一个工厂类：**DriveFileFactory** ，由它负责完成 DriveFile 的生产和装填，同时还可以实现诸如：缓存、增量加载等功能。
此外，文件不仅需要生成，还需要进行各种操作，如增删改查等。由于我们采用了「贫血模型」，因此不能将操作耦合到 DriveFile 模型中。为了实现这一目标，我们需要一个统一的入口 **DriveAPI** 来对接外部模块，达到入口收归。

![image-20230815155053872](https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308151550490.png)



经过调整后，我们可以在不同场景下消费同一个文件。同时，只需要一套维护成本，在功能迭代时，只需在 Drive 内部完成迭代，对业务方来说是透明的。这样的设计能提高开发效率和维护便利性。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308151641010.png" alt="image-20230817171349246" style="zoom:75%;" />



## 2. 统一的文件预览服务


正如前文所述，针对文件预览功能，存在多套实现且互相复用困难的问题。在软件设计中，有一句经典黑话：**「遇事不决，再加一层。」**
虽然这句话带有讽刺，但它也反映了一定的道理。从腾讯文档的文件预览现状来看，实际上已经具备了音频、视频、图片、Office 文档的预览能力。问题在于，这些功能都是由业务层自行实现的，导致耦合严重，无法复用。在这种情况下，我们需要一个统一的文件预览服务。

从竞品方面来看，由于产品定位不同，各自的优势也有所差异：
1. Google Docs 更倾向于云盘文件管理能力。
2. 飞书文档则更侧重于从业务出发，构建统一的预览能力。
3. 金山文档则专注于打造一流的 Office 文件预览 SaaS 服务。

因此，我们可以借鉴竞品的优势，为腾讯文档构建一个统一的文件预览服务，以解决现有的问题。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308152107648.png" alt="image-20230815210716773" style="zoom: 30%;" />

经过竞品分析过后，发现飞书的结构会比较适合我们，我们需要构建一个全面且灵活的文件预览能力：

- 可灵活配置的文件预览
- 支持绝大多数文件格式预览
- 轻松的接入方式

遵循分层原则，我们选择在应用与基础中间，建设 **DriveEngine**，以完成不同文件预览能力的适配和调度。之所以不叫 PreviewEngine 或类似名称，是因为我们还需要考虑未来可能对文件进行编辑等操作，这样一来，功能范围就不仅仅是预览的事情了。
通过构建 DriveEngine，我们可以实现统一的文件预览服务，提高系统的复用性和可维护性。这将有助于我们更高效地进行功能迭代和优化，同时确保系统的稳定性和可靠性。在未来，我们还可以根据需求扩展 DriveEngine 的功能，以满足更多的业务场景。



<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308152112034.png" alt="建设统一预览服务" style="zoom: 30%;" />


从上图中我们可以看到，DriveEngine 内部遵循开放封闭原则，对外提供统一高可用的 API 接口和可选的配置文件。它接收统一的文件模型 DriveFile，交给调度器，由调度器根据 DriveFile 的 MIME Type 来分流到不同文件驱动。
而文件驱动放大来看，横向设计统一抽象的 Drivers Interface，不同的文件类型实现具体的文件驱动 Drivers，如：Office 文件的 OfficeDrivers、视频文件的 VideoDrivers、音频文件的 AudioDrivers 等。Drivers 底层则接入不同的组件，如：Office 文件由自研的文档渲染能力、视频文件则封装腾讯视频的 SuperVideo 组件、音频文件则自研渲染等，以此来完成不同文件类型的能力适配。
纵向来看，是高内聚的，Interface、Drivers 和基础组件内聚而成。这样的设计有利于后续可以基于性能考虑进行代码分割，通过调度器根据不同文件按需进行代码异步加载。

构建统一的文件预览服务（DriveEngine）后，我们可以获得以下好处：
1. 灵活配置，快速切换：例如，文档预览曾使用腾讯云万象预览能力，日后可按需接入微软或金山的文档预览能力。只需使用新的 Driver 完成适配，这就是「开放封闭原则」的逻辑。甚至日后可以支持像 Google Docs 那样让用户选择文件的打开方式，如视频除了内建预览，还可以打开腾讯智影进行编辑。
2. 交互统一，维护方便：预览体验得到统一，细节问题如 loading、权限控制、错误处理等也得到统一。
3. 满足需求快速迭代：未来新增文件类型支持，如增加 Markdown 支持，只需增加一个 Driver，业务方相对透明。



## 3. 逐渐生长的架构


从前文中，我们已经针对两个单点问题进行了解决：「文件模型」和「预览服务」。
现在回过头来看，实际上预览服务的构建是依赖于文件模型的，以分层思维来思考，文件模型应该位于预览服务的下层。
预览服务内部也存在分层，下层由 DriveEngine 完成预览的主要能力，上层构建场景适配能力，如独立文件详情页、浮动预览、附件等。
当我们将重构的新模块放在架构上来看，其实已经能看出大致的框架了：

1. 底层：文件的概念，封装原子操作（DriveFile、DriveAPI）
2. 中层：抽象的基础通用模块（DriveEngine）
3. 高层：为适配不同场景，以能快速接入的制品（DrivePreview、DriveApplication、DriveAttachment）
4. 业务层：腾讯文档内的业务。

架构从下往上生长，底层提供基础服务，中层完成通用模块，高层完成场景适配，顶层则构建各品类业务。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308161639840.png" alt="drive-file-sdk-architecture-v2.drawio" style="zoom: 30%;" />

接下来，我们继续思考，如果未来有新的内容加入进来，这个架构又当如何生长？
预览服务完善了「文件消费」能力，当我们需要为完善「文件生产」能力而迭代「上传导入模块」的时候呢？
上传导入这个事情，同样存在着不少的历史包袱。在进行重构之前，存在 10+ 个上传场景，8 处分散的实现，前后端连起来又是 3 套不同的流程，对应不同的接口和团队。

根据已有框架的分层思路，我们对上传导入模块进行了重新设计：


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308161210142.png" alt="tdoc-drive-uploader.drawio" style="zoom:50%;" />


然后将其放在整体架构中，符合基本分层。这时，我们发现架构开始变得更加丰富，它开始长胖了。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308161719139.png" alt="drive-file-sdk-architecture-v3.drawio" style="zoom:50%;" />



当未来有其他业务需要迭代时，我们可以以此架构为指导，逐渐让架构生长起来。
再向前一步，根据以往的经验来看诗和远方，我们预见未来可能会有开放平台的需求。开放平台的接入应当从纵向考虑，可以使用每一层的能力来扩展定制应用和场景，按照开放程度由浅入深。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308171539670.png" alt="drive-file-sdk-architecture-v4.drawio" style="zoom:50%;" />



从竞品的开放平台来看，开放程度也是有深浅之分的：
1. [金山 WebOffice JSSDK](https://wwo.wps.cn/docs/front-end/introduction/jssdk-and-weboffice/)：以高度集成的页面制品来提供能力。
2. [飞书云文档组件](https://open.feishu.cn/document/common-capabilities/web-components/uYDO3YjL2gzN24iN3cjN/introduction)：以灵活使用的组件库来提供能力。
3. [Google Drive API](https://developers.google.com/drive/api/guides/about-sdk?hl=zh-cn)：以细粒度的原子性操来提供能力。

目前，在高层制品中，我们以高度集成的独立页面（如图中的 OpenDriveApplication）支持了「微云」和「QQ群文件」的接入。

在未来，当业务对开放平台提出更高的开放性要求时，我们可以按开放程度由浅入深地向下构建更细粒度的开放能力，如图中的 OpenDriveEngine、OpenDriveUploader、OpenDriveFile、OpenDriveAPI 等。这将有助于满足更多业务场景的需求，提高系统的灵活性和可扩展性。



# 四、架构既始于业务，也终于业务

综观以上全文，我们通过竞品分析得出了诗和远方。然后分析了现状，定义了 R1。接着从单点问题到构建框架，找到了从 R1 → R2 的路径，描述了架构是如何生长的。从文章篇幅和完整度来看，貌似行文到此就可以结束了。

然而，中国上下五千年两个半圣人之一圣人的王阳明跟我们倡导「知行合一」。前文所有的描述都在围绕一个「知」字，如果不笃行下去，不将其付诸实践，很容易会被认为无法落地，只是纸上谈兵。纵然知与行本身也是无法分割的，当我们在描述竞品的时候，也是用实际行动去调研，才总结出 Drive 的能力圈；当进行现状分析的时候，也是用实际行动梳理现状，才看得到改造的方法；当我们定义架构的时候，也是从解决单点问题一步一步总结得出整体框架。

但我认为，分享我们在让架构逐步落地的经验和方法论也是非常有价值的。

我们应当强调**「架构始于业务」**，由于组织的首要目标是盈利。要是没有了业务，技术又何谈价值？之前有看过很多做架构也好，做基础设施也罢，比较喜欢用「建筑」来类比，认为应该用最大的努力把技术地基打扎实了，然后才能够支撑更高的业务大厦。然而，这种观点在迅速迭代的现代互联网产品中显然是不切实际的。

现代互联网产品是在不断的尝试、验证和迭代中螺旋式成长起来的。技术也应该是螺旋式迭代的，业务发展了，架构也就产生了。正如曾探曾哥跟我们说的：「架构的本质目标是在变化发生时，以最少的成本达成」。当产品生命周期结束，不再需要迭代和修改代码时，架构也就失去了意义。

在 Drive 中台的建设过程中，尽管我们通过前期的思考和调研，得出了 Drive 的能力圈和架构定义。但在实际的执行过程中，还是**以「生长型架构」为指导，以产品节奏为依托，去逐步完善蓝图**。这样，每一步的技术投入都能创造价值，从用户的角度来看，能及时感受到产品的改进。从开发的角度来看，能及时得到正向的反馈。从老板的角度，能及时看到效率的变化。

实际上，我们在执行过程中也是螺旋式的一点点修正最初的方案。毕竟，人无完人，技术也没有完美的设计，变化一直在发生。只要我们还能看得到远方的目标，即使风大雨大，也不会偏离正确的航向太远。


<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308171624121.png" alt="以生长型架构为指导，以产品节奏为依托" style="zoom:50%;" />

举个简单的例子，像 Drive 前端中台的建设，一开始我们是先构建 DriveApplication 的。然后再根据产品节奏在支持音视图预览的时候，完成通用能力的下沉，构建了 DriveEngine，DriveAPI 等。接着又在一次需要统一附件体验的时候，构建统一的文件模型 DriveFile，然后再花点时间从下往上重塑上层设施，只要在上层设计的时候稍微考虑到未来，预留接口，就能很轻易的完成更改。

而在推进的过程中，我们倡导技术团队应当以 Owner 的角色推动每一项需求落地，这样我们的架构才能一点点的落地，最终成就我们的蓝图，走向诗和远方。

有了架构上的一个蓝图的轮廓，后面我们需要以 Drive 中台的形式，去构绕文件的「生产、消费、管理」来构建不一样的能力的时候，也可以以此蓝图来进行指导。只要一直往前走，Drive 中台就会越来越完善，能力也会越来越丰富。

当下我们也在为不同的季度目标，不同的产品节奏，来持续夯实 Drive 中台的能力。Drive 业务也已经能在新的台阶上去迭代，产生了新的一条 S 曲线。未来随着业务发展，这条 S 曲线将来也会迎来衰老和下降。届时一定还会有新的人产生新的方法，构造出新的一条 S 曲线。



<img src="https://bluesun-1252625244.cos.ap-guangzhou.myqcloud.com/img/202308171713472.png" alt="image-20230817171349246" style="zoom:40%;" />


最后，
架构并非一成不变的，任何技术都有一个生命周期。随着业内通用技术的更替、产品业务的迭代和人员的替换等变动，新陈代谢和腐化都在所难免。防腐策略除了采用自动化和规范等限制外，在「传承」方面下点功夫也不失为一种好方式。将理念和思考传承下去；当时设计的思路和想法，也传承下去；基本的设计原则和编码规范，也传承下去。这也是写这篇文章的第一个目的。如果非要问第二个目的，那就是让未来需要重构架构的同学在看了此文后，可以轻一点喷：「这套架构呢，放在当时是合理的，只是现在情况变了，不再适用了」。
毕竟，
**架构即始于业务，也终于业务。**



# 致谢

Drive 中台的建设并非个人之功，而是整个团队共同努力的成果。
感谢 Drive 产品团队的宝贵建议，大家共同参与了无数次头脑风暴会议，共同探讨 Drive 中台的愿景，画满了会议室的一整墙后又一整墙，一次次充实着我们的想法，让技术团队也学会了不少的产品思维。同时，在需求迭代过程中，给予了技术团队进行基础设施建设以足够的信任和尊重，为我们承受排期压力。
感谢 Slide 团队为我们沉淀下来的音视频预览组件，有了这些组件的积累，我们才能避免更多的弯路和坑。
感谢 Drive 后端团队对我们提出的合并接口等重构方案的鼎力支持。
感谢 Drive 前端技术团队的每一位成员，Drive 中台的建设能够落地，大家功不可没。
最后，群里的各位都是人才，说话又好听，我超喜欢这里的感觉！
